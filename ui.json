# Create user and set up the folders
pw useradd -n sickrage -c "bookstack" -s /sbin/nologin -w no
git clone https://github.com/BookStackApp/BookStack.git --branch release --single-branch /usr/local/bookstack

# Install dependencies
pkg install -y git nginx openssl mariadb102-server php71 php71-tidy php71-tokenizer php71-openssl php71-pdo php71-mysqli php71-simplexml php71-mbstring

# Enable autostart for php, nginx and mysql
sysrc mysql_enable=YES
sysrc nginx_enable=YES
sysrc php_fpm_enable=YES
service mysql-server start

# Setup php-fpm 
sed -i '' -e 's?listen = 127.0.0.1:9000?listen = /var/run/php-fpm.sock?g' /usr/local/etc/php-fpm.d/www.conf
sed -i '' -e 's/;listen.owner = www/listen.owner = www/g' /usr/local/etc/php-fpm.d/www.conf
sed -i '' -e 's/;listen.group = www/listen.group = www/g' /usr/local/etc/php-fpm.d/www.conf
sed -i '' -e 's/;listen.mode = 0660/listen.mode = 0600/g' /usr/local/etc/php-fpm.d/www.conf
sed -i '' -e 's?;cgi.fix_pathinfo=1?cgi.fix_pathinfo=0?g' /usr/local/etc/php.ini

# Copy php.ini
cp /usr/local/etc/php.ini-production /usr/local/etc/php.ini

# Create database
mysql -u root -e "CREATE DATABASE bookstack;"
grant all on bookstack.* to bookstack@localhost identified by 'bookstack';
mysql -u root -e "FLUSH PRIVILEGES;"

# Install boo
cd /usr/local/bookstack
composer install
cp .env.example .env
# Add seds